<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QRLogix ARGOS</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    <style>
        html, body {
            height: 100%;
            margin: 0;
            background-color: #C4D600;
            font-family: 'Montserrat', sans-serif;
            color: #071D49;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            text-align: center;
        }
        body {
            padding: 0 20px;
        }
        header {
            margin-bottom: 1rem;
        }
        header img {
            max-width: 80px;
        }
        h1 {
            font-size: 2.8rem;
            font-weight: 700;
            margin: 0;
            margin-bottom: 0.3rem;
            line-height: 1.1;
        }
        h2 {
            font-size: 1.4rem;
            font-weight: 400;
            margin: 0 0 2rem 0;
        }
        form {
            width: 100%;
            max-width: 320px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        input[type="text"] {
            width: 100%;
            padding: 14px 16px;
            font-size: 1.4rem;
            border: none;
            border-radius: 8px;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 1.5rem;
            box-sizing: border-box;
        }
        input[type="text"]:focus {
            outline: none;
            box-shadow: 0 0 6px rgba(7,29,73,0.6);
        }
        button {
            width: 100%;
            background-color: #071D49;
            color: #fff;
            font-size: 1.2rem;
            font-weight: 700;
            padding: 14px 0;
            border: none;
            border-radius: 8px;
            transition: background-color 0.3s ease;
            user-select: none;
        }
        .mensaje {
            margin-top: 2rem;
            font-weight: 700;
            font-size: 1.2rem;
            color: #071D49;
        }
        .footer {
            margin: 2rem 0;
            font-size: 0.9rem;
            color: #5a5a5a;
            }
        
        @media (max-height: 500px) {
            h1 {
                font-size: 2rem;
            }
            h2 {
                font-size: 1rem;
            }
            input[type="text"] {
                font-size: 1.1rem;
                padding: 12px 14px;
            }
            button {
                font-size: 1rem;
                padding: 12px 0;
            }
        }

        span {
            font-size: 1rem;
            color: red;
        }

    </style>
</head>
<body>
    <header>
        <img src="/static/imagenes/ARG_logo_hor_color_no_background.png" alt="Logo Argos">
    </header>
    <h1>AMIGO CONDUCTOR,</h1>
    <h2>REGISTRE SU LLEGADA</h2>

    <script>
    // const PLANTA_LAT = 9.25831;
    // const PLANTA_LON = -79.65848;
    // const RANGO_METROS = 300;

    const PLANTA_LAT = 9.028398007355186;
    const PLANTA_LON = -79.46020053317156;
    const RANGO_METROS = 300;

// Ocultar el formulario hasta validar
document.addEventListener("DOMContentLoaded", () => {
    const form = document.querySelector("form");
    const mensaje = document.createElement("p");
    mensaje.textContent = "Validando ubicación...";
    mensaje.style.fontWeight = "700";
    mensaje.style.marginTop = "1rem";
    document.body.insertBefore(mensaje, form);
    form.style.display = "none";

    // Calcular distancia entre coordenadas
    function distanciaMetros(lat1, lon1, lat2, lon2) {
        const R = 6371e3;
        const φ1 = lat1 * Math.PI / 180;
        const φ2 = lat2 * Math.PI / 180;
        const Δφ = (lat2 - lat1) * Math.PI / 180;
        const Δλ = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(Δφ/2)**2 + Math.cos(φ1)*Math.cos(φ2)*Math.sin(Δλ/2)**2;
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
    }

    navigator.geolocation.getCurrentPosition(success => {
        const lat = success.coords.latitude;
        const lon = success.coords.longitude;
        const dist = distanciaMetros(lat, lon, PLANTA_LAT, PLANTA_LON);

        if (dist <= RANGO_METROS) {
            mensaje.textContent = "Ubicación validada ✅";
            form.style.display = "flex";
        } else {
            window.location.href = "/geozona";
        }
    }, error => {
        mensaje.textContent = "No se pudo obtener la ubicación. Activa el GPS e inténtalo nuevamente.";
    });
});
</script>

    <form 
        action="/scan/{{ punto }}" 
        method="post">
        <!-- Campo oculto con el punto escaneado -->
        <input 
            type="hidden" 
            name="punto" 
            value="{{ punto }}">

        <input 
            type="text" 
            name="plate" 
            placeholder="EH1234" 
            required autocomplete="off" 
            maxlength="6" 
            pattern="[A-Z0-9]{1,6}" 
            oninput="this.value = this.value.toUpperCase()">

        <button type="submit" {% if submitted %}disabled{% endif %}>Registrar</button>
    </form>
    {% if message %}
    <div class="mensaje">{{ message }}</div>
    {% endif %}

    <h3><span>Si no eres conductor de ensacado, porfavor ignorar este QR.</span></h3>

</body>
</html>